# Runner ìƒì„± ë¡œì§ ìƒì„¸ ì„¤ëª…

JIT Runner Managerì˜ Runner ìƒì„± ë° ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë¡œì§ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì²˜ë¦¬ íë¦„](#ì²˜ë¦¬-íë¦„)
3. [ì œí•œ í™•ì¸ ë¡œì§](#ì œí•œ-í™•ì¸-ë¡œì§)
4. [ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë°©ì‹](#ëŒ€ê¸°ì—´-ì²˜ë¦¬-ë°©ì‹)
5. [ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ](#ì‹œë‚˜ë¦¬ì˜¤-ì˜ˆì‹œ)
6. [FIFO ìˆœì„œ ë³´ì¥](#fifo-ìˆœì„œ-ë³´ì¥)
7. [FAQ](#faq)

---

## ê°œìš”

JIT Runner ManagerëŠ” GitHub Enterprise Serverì—ì„œ workflowê°€ ì‹œì‘ë  ë•Œ ì‹¤ì‹œê°„ìœ¼ë¡œ Runnerë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### í•µì‹¬ ì›ì¹™

| ì—­í•  | ë‹´ë‹¹ |
|------|------|
| Runner ìƒì„± ê²°ì • | JIT Runner Manager |
| **ëŒ€ê¸°ì—´ ê´€ë¦¬** | **JIT Runner Manager (Redis)** |
| Webhook ë°œì†¡ | GitHub Enterprise Server (1íšŒë§Œ) |

### ì¤‘ìš”í•œ ì 

> âš ï¸ **GitHubì€ `workflow_job.queued` webhookì„ ì¬ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!**
>
> Webhookì€ Job ìƒíƒœê°€ ë³€ê²½ë  ë•Œ **1íšŒë§Œ** ë°œì†¡ë©ë‹ˆë‹¤.
> ë”°ë¼ì„œ JIT Runner Managerê°€ **ìì²´ ëŒ€ê¸°ì—´**ì„ Redisì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.

---

## ì²˜ë¦¬ íë¦„

### ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GitHub Enterprise Server                            â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         Workflow Jobs                                 â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚  â€¢ ìƒˆ workflow ì‹œì‘ â†’ queued ì´ë²¤íŠ¸ ë°œìƒ (1íšŒë§Œ!)                     â”‚  â”‚
â”‚   â”‚  â€¢ Runner ì—†ìœ¼ë©´ â†’ GitHub UIì—ì„œ "Waiting for runner" í‘œì‹œ           â”‚  â”‚
â”‚   â”‚  â€¢ íƒ€ì„ì•„ì›ƒ (ê¸°ë³¸ 6ì‹œê°„) í›„ ì‹¤íŒ¨ ì²˜ë¦¬                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                               â”‚
â”‚                    workflow_job webhook (1íšŒ ë°œì†¡)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         JIT Runner Manager                                    â”‚
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ FastAPI Webhook â”‚â”€â”€â”€â”€â–¶â”‚  Celery Worker  â”‚â”€â”€â”€â”€â–¶â”‚  Kubernetes     â”‚       â”‚
â”‚   â”‚   Receiver      â”‚     â”‚                 â”‚     â”‚  (Pod ìƒì„±)     â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                           â”‚     Redis       â”‚                                â”‚
â”‚                           â”‚  (ìƒíƒœ + ëŒ€ê¸°ì—´) â”‚  â—€â”€â”€ ìì²´ ëŒ€ê¸°ì—´ ê´€ë¦¬!        â”‚
â”‚                           â”‚  â€¢ org:X:runningâ”‚                                â”‚
â”‚                           â”‚  â€¢ org:X:pendingâ”‚  â—€â”€â”€ ëŒ€ê¸° ì¤‘ì¸ Job ëª©ë¡       â”‚
â”‚                           â”‚  â€¢ global:total â”‚                                â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì´ë²¤íŠ¸ë³„ ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        workflow_job.queued ì´ë²¤íŠ¸                            â”‚
â”‚                                                                              â”‚
â”‚  1. Webhook ìˆ˜ì‹  â†’ ë¼ë²¨ í™•ì¸ (code-linux)                                    â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  2. Redis ëŒ€ê¸°ì—´ì— Job ì €ì¥ (ëª¨ë“  ìš”ì²­)                                      â”‚
â”‚     â””â”€â”€ org:{name}:pending ë¦¬ìŠ¤íŠ¸ì— Job ì •ë³´ ì¶”ê°€                            â”‚
â”‚                                                                              â”‚
â”‚  â€» ì œí•œ í™•ì¸ ì—†ì´ ë¬´ì¡°ê±´ ëŒ€ê¸°ì—´ì— ì €ì¥!                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              process_pending_queues (5ì´ˆë§ˆë‹¤ ì‹¤í–‰, ë°°ì¹˜ ì²˜ë¦¬)                â”‚
â”‚                                                                              â”‚
â”‚  1. K8s ìƒíƒœ ë™ê¸°í™”                                                          â”‚
â”‚     â””â”€â”€ Pod ìƒíƒœ ì¡°íšŒ â†’ Redis ì¹´ìš´í„° ê°±ì‹                                     â”‚
â”‚         (ì¢…ë£Œëœ Pod ìë™ ê°ì§€)                                               â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  2. ì „ì²´ ì œí•œ í™•ì¸                                                           â”‚
â”‚     â””â”€â”€ total_running >= max_total? â”€â”€â”€Yesâ”€â”€â”€â–¶ ì²˜ë¦¬ ê±´ë„ˆëœ€                   â”‚
â”‚                         â”‚                                                    â”‚
â”‚                        No                                                    â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  3. ëª¨ë“  Orgì˜ pending jobì„ timestamp ìˆœìœ¼ë¡œ ì¡°íšŒ (ì „ì—­ FIFO)               â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  4. ìµœëŒ€ MAX_BATCH_SIZE(10)ê°œê¹Œì§€ Job ì„ íƒ                                   â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â”œâ”€â”€ (org_running + ì´ë²ˆ ì„ íƒ ìˆ˜) >= org_limit? â”€â”€â”€Yesâ”€â”€â”€â–¶ ê±´ë„ˆëœ€         â”‚
â”‚     â”‚         â”‚                                                              â”‚
â”‚     â”‚        No                                                              â”‚
â”‚     â”‚         â”‚                                                              â”‚
â”‚     â”‚         â–¼                                                              â”‚
â”‚     â””â”€â”€ Job ì„ íƒ (org_selected_count ì¦ê°€)                                   â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  5. ì„ íƒëœ Jobë“¤ì„ ëŒ€ê¸°ì—´ì—ì„œ ì œê±°                                           â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  6. ì„ íƒëœ Jobë“¤ì— ëŒ€í•´ Runner ìƒì„± íƒœìŠ¤í¬ ì¼ê´„ í˜¸ì¶œ (ë³‘ë ¬ ì²˜ë¦¬)             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       workflow_job.completed ì´ë²¤íŠ¸                          â”‚
â”‚                                                                              â”‚
â”‚  â€» ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ! (ë¡œê¹…ë§Œ)                                                   â”‚
â”‚                                                                              â”‚
â”‚  RunnerëŠ” Ephemeral ëª¨ë“œë¡œ ë™ì‘í•˜ì—¬ Job ì™„ë£Œ ì‹œ Podê°€ ìë™ ì¢…ë£Œë©ë‹ˆë‹¤.       â”‚
â”‚  Pod ì¢…ë£ŒëŠ” process_pending_queuesì—ì„œ K8s ìƒíƒœ ì¡°íšŒë¡œ ê°ì§€ë©ë‹ˆë‹¤.           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Pod ì¢…ë£Œ ê°ì§€ íë¦„                                  â”‚
â”‚                                                                              â”‚
â”‚  1. Ephemeral Runnerê°€ Job ì™„ë£Œ í›„ ìë™ ì¢…ë£Œ                                 â”‚
â”‚     â””â”€â”€ Pod ìƒíƒœ: Running â†’ Succeeded/Failed                                 â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  2. process_pending_queues ì‹¤í–‰ ì‹œ (5ì´ˆë§ˆë‹¤)                                 â”‚
â”‚     â””â”€â”€ K8s APIë¡œ Pod ìƒíƒœ ì¡°íšŒ                                              â”‚
â”‚     â””â”€â”€ Running/Pending Podë§Œ ì¹´ìš´íŠ¸                                         â”‚
â”‚     â””â”€â”€ Redis ì¹´ìš´í„° ìë™ ê°±ì‹  (ì¢…ë£Œëœ Pod ë°˜ì˜)                             â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  3. í•´ë‹¹ Orgì— ì—¬ìœ  ìƒê¹€ â†’ ëŒ€ê¸°ì—´ì—ì„œ ë‹¤ìŒ Job ì²˜ë¦¬                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì œí•œ í™•ì¸ ë¡œì§

### 2ë‹¨ê³„ ì œí•œ í™•ì¸

Runner ìƒì„± ì „ì— ë‘ ê°€ì§€ ì œí•œì„ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤:

```python
# 1. Organization ì œí•œ í™•ì¸
org_running = redis_client.get_org_running_count_sync(org_name)
org_limit = redis_client.get_effective_org_limit_sync(org_name)  # ì»¤ìŠ¤í…€ ë˜ëŠ” ê¸°ë³¸ê°’

if org_running >= org_limit:
    # Redis ëŒ€ê¸°ì—´ì— Job ì •ë³´ ì €ì¥
    redis_client.add_pending_job_sync(
        org_name=org_name,
        job_id=job_id,
        run_id=run_id,
        job_name=job_name,
        repo_full_name=repo_full_name,
        labels=labels
    )
    return {"status": "pending", "reason": "org_limit_reached"}

# 2. ì „ì²´ ì œí•œ í™•ì¸
total_running = redis_client.get_total_running_sync()

if total_running >= config.runner.max_total:
    # Redis ëŒ€ê¸°ì—´ì— Job ì •ë³´ ì €ì¥
    redis_client.add_pending_job_sync(...)
    return {"status": "pending", "reason": "total_limit_reached"}

# ë‘ ì¡°ê±´ ëª¨ë‘ í†µê³¼ â†’ Runner ìƒì„±
```

### ì œí•œ ìš°ì„ ìˆœìœ„

```
                    ìš”ì²­ ë„ì°©
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Org ì œí•œ (org_limit)   â”‚  â† ë¨¼ì € í™•ì¸
            â”‚ ì˜ˆ: A org = 10ê°œ      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              org_running < org_limit?
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             Yes                  No
              â”‚                    â”‚
              â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì „ì²´ ì œí•œ í™•ì¸   â”‚    â”‚ Redis ëŒ€ê¸°ì—´    â”‚
    â”‚ max_total=100   â”‚    â”‚ ì €ì¥ (FIFO)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    total_running < max_total?
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
   Yes               No
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Runner  â”‚   â”‚ Redis ëŒ€ê¸°ì—´    â”‚
â”‚  ìƒì„±   â”‚   â”‚ ì €ì¥ (FIFO)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì»¤ìŠ¤í…€ Org ì œí•œ

Organizationë³„ë¡œ ë‹¤ë¥¸ ì œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

| Organization | ì»¤ìŠ¤í…€ ì œí•œ | ì ìš© ì œí•œ |
|--------------|------------|----------|
| platform-team | 25 | 25 |
| small-project | 5 | 5 |
| regular-org | (ì—†ìŒ) | 10 (ê¸°ë³¸ê°’) |

```python
def get_effective_org_limit_sync(self, org_name: str) -> int:
    """Organizationì˜ ìœ íš¨ ì œí•œ ì¡°íšŒ (ì»¤ìŠ¤í…€ ë˜ëŠ” ê¸°ë³¸ê°’)"""
    custom_limit = self.get_org_max_limit_sync(org_name)
    if custom_limit is not None:
        return custom_limit
    return self.config.runner.max_per_org  # ê¸°ë³¸ê°’ (ì˜ˆ: 10)
```

---

## ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë°©ì‹

### í•µì‹¬: JIT Runner Managerê°€ Redisì—ì„œ ëŒ€ê¸°ì—´ ê´€ë¦¬

**GitHubì€ Webhookì„ ì¬ì „ì†¡í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ**, JIT Runner Managerê°€ ìì²´ ëŒ€ê¸°ì—´ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Redis                                            â”‚
â”‚                                                                               â”‚
â”‚   ëŒ€ê¸°ì—´ (org:{name}:pending):                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â”‚  org:A:pending = [                                                   â”‚    â”‚
â”‚   â”‚    {"job_id": 11, "timestamp": 1701590400.1, ...},                  â”‚    â”‚
â”‚   â”‚    {"job_id": 12, "timestamp": 1701590401.2, ...},                  â”‚    â”‚
â”‚   â”‚    ...                                                               â”‚    â”‚
â”‚   â”‚  ]                                                                   â”‚    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â”‚  org:B:pending = [                                                   â”‚    â”‚
â”‚   â”‚    {"job_id": 21, "timestamp": 1701590400.5, ...},  â† A-job-12ë³´ë‹¤   â”‚    â”‚
â”‚   â”‚    ...                                                 ë¨¼ì € ì²˜ë¦¬ë¨   â”‚    â”‚
â”‚   â”‚  ]                                                                   â”‚    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â”‚   ë°°ì¹˜ ì²˜ë¦¬ ì‹œ â†’ ëª¨ë“  Orgì˜ pending jobì„ timestamp ìˆœìœ¼ë¡œ ì •ë ¬ í›„           â”‚
â”‚                  ìµœëŒ€ MAX_BATCH_SIZE(10)ê°œê¹Œì§€ ë™ì‹œì— Runner ìƒì„±             â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ëŒ€ê¸°ì—´ ì €ì¥ ì •ë³´

ì œí•œì— ë„ë‹¬í•˜ë©´ ì „ì²´ Job ì •ë³´ë¥¼ Redisì— ì €ì¥í•©ë‹ˆë‹¤:

```python
# Redis ëŒ€ê¸°ì—´ì— ì €ì¥ë˜ëŠ” ì •ë³´ (JSON)
{
    "job_id": 12345,
    "run_id": 67890,
    "job_name": "build",
    "repo_full_name": "org-A/my-repo",
    "labels": ["code-linux"],
    "org_name": "org-A",
    "timestamp": 1701590400.123456  # ì „ì—­ FIFO ìˆœì„œë¥¼ ìœ„í•œ timestamp
}
```

### ë°°ì¹˜ ì²˜ë¦¬ íë¦„

```
1. ì—¬ëŸ¬ Jobì´ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë¨ (timestamp í¬í•¨)
   â””â”€â”€ A-job-11 (timestamp: 1701590400.1)
   â””â”€â”€ B-job-21 (timestamp: 1701590400.5)
   â””â”€â”€ A-job-12 (timestamp: 1701590401.2)
   â””â”€â”€ C-job-31 (timestamp: 1701590401.5)
   â””â”€â”€ ...

2. process_pending_queues ì‹¤í–‰ (5ì´ˆë§ˆë‹¤)
   â””â”€â”€ ëª¨ë“  Orgì˜ pending jobì„ timestamp ìˆœìœ¼ë¡œ ì •ë ¬ (ì „ì—­ FIFO)
   â””â”€â”€ ì •ë ¬ ê²°ê³¼: [A-job-11, B-job-21, A-job-12, C-job-31, ...]
   
3. ìµœëŒ€ MAX_BATCH_SIZE(10)ê°œê¹Œì§€ Job ì„ íƒ
   â””â”€â”€ A-job-11: A org (running=8, selected=0, limit=10) â†’ ì„ íƒ âœ“
   â””â”€â”€ B-job-21: B org (running=9, selected=0, limit=10) â†’ ì„ íƒ âœ“
   â””â”€â”€ A-job-12: A org (running=8, selected=1, limit=10) â†’ ì„ íƒ âœ“
   â””â”€â”€ C-job-31: C org (running=10, selected=0, limit=10) â†’ ê±´ë„ˆëœ€ âœ— (limit ë„ë‹¬)
   â””â”€â”€ ... (ìµœëŒ€ 10ê°œê¹Œì§€)

4. ì„ íƒëœ Jobë“¤ì— ëŒ€í•´ Runner ìƒì„± íƒœìŠ¤í¬ ì¼ê´„ í˜¸ì¶œ (ë³‘ë ¬ ì²˜ë¦¬)
```

### ë°°ì¹˜ ì²˜ë¦¬ì˜ ì¥ì 

| ê¸°ì¡´ ë°©ì‹ | ë°°ì¹˜ ì²˜ë¦¬ ë°©ì‹ |
|-----------|---------------|
| ìŠ¤ì¼€ì¤„ë§ˆë‹¤ Orgë‹¹ 1ê°œì”© ì²˜ë¦¬ | ìŠ¤ì¼€ì¤„ë§ˆë‹¤ ìµœëŒ€ 10ê°œ ë™ì‹œ ì²˜ë¦¬ |
| Org ìˆœíšŒ ìˆœì„œì— ë”°ë¼ ì²˜ë¦¬ | timestamp ê¸°ë°˜ ì „ì—­ FIFO |
| ëŒ€ê¸°ì—´ ì†Œì§„ì— ì˜¤ë˜ ê±¸ë¦¼ | ëŒ€ê¸°ì—´ ë¹ ë¥´ê²Œ ì†Œì§„ |

### êµ¬ì„±ìš”ì†Œë³„ ì—­í• 

| êµ¬ì„±ìš”ì†Œ | ì—­í•  | ëŒ€ê¸°ì—´ ê´€ë¦¬ |
|---------|------|------------|
| FastAPI Webhook | ì´ë²¤íŠ¸ ìˆ˜ì‹  | âŒ |
| Celery Worker | Runner ìƒì„±/ì‚­ì œ, **ëŒ€ê¸°ì—´ ì²˜ë¦¬** | âœ… |
| **Redis** | ìƒíƒœ ì €ì¥, **ëŒ€ê¸°ì—´ ì €ì¥** | âœ… |
| GitHub | Workflow ì‹¤í–‰ | âŒ (Webhook ì¬ì „ì†¡ ì•ˆí•¨) |

---

## ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤: ëŒ€ê·œëª¨ ë™ì‹œ ìš”ì²­

**ì¡°ê±´:**
- A org: 35ê°œ ìš”ì²­, limit: 10
- B org: 50ê°œ ìš”ì²­, limit: 10
- C org: 72ê°œ ìš”ì²­, limit: 10
- ì „ì²´ max_total: 100

**ê²°ê³¼ ë¶„ì„:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ìš”ì²­ í˜„í™©                                       â”‚
â”‚                                                                              â”‚
â”‚   Organization â”‚ ìš”ì²­ ìˆ˜ â”‚ Org Limit â”‚ í• ë‹¹ë¨ â”‚ Redis ëŒ€ê¸°ì—´                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   A org        â”‚   35    â”‚    10     â”‚   10   â”‚  25ê°œ ëŒ€ê¸°                  â”‚
â”‚   B org        â”‚   50    â”‚    10     â”‚   10   â”‚  40ê°œ ëŒ€ê¸°                  â”‚
â”‚   C org        â”‚   72    â”‚    10     â”‚   10   â”‚  62ê°œ ëŒ€ê¸°                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   í•©ê³„         â”‚  157    â”‚     -     â”‚   30   â”‚ 127ê°œ ëŒ€ê¸°                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- ì „ì²´ max_totalì´ 100ì´ì§€ë§Œ, **Orgë³„ limit(10)ìœ¼ë¡œ ì¸í•´ 30ê°œë§Œ ì‚¬ìš©**
- 127ê°œ ìš”ì²­ì€ **Redis ëŒ€ê¸°ì—´**ì—ì„œ ìˆœì„œ ëŒ€ê¸°
- Runner ì™„ë£Œ ì‹œ í•´ë‹¹ Orgì˜ ëŒ€ê¸°ì—´ì—ì„œ ë‹¤ìŒ Job ì²˜ë¦¬

### ì‹œë‚˜ë¦¬ì˜¤: ì»¤ìŠ¤í…€ ì œí•œ ì ìš©

**ì¡°ê±´:**
- A org: 35ê°œ ìš”ì²­, **custom limit: 25**
- B org: 50ê°œ ìš”ì²­, **custom limit: 50**
- C org: 72ê°œ ìš”ì²­, limit: 10 (ê¸°ë³¸ê°’)
- ì „ì²´ max_total: 100

**ê²°ê³¼:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Organization â”‚ ìš”ì²­ ìˆ˜ â”‚ Org Limit â”‚ í• ë‹¹ë¨ â”‚ ë¹„ê³                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   A org        â”‚   35    â”‚    25     â”‚   25   â”‚  ì»¤ìŠ¤í…€ limit               â”‚
â”‚   B org        â”‚   50    â”‚    50     â”‚   50   â”‚  ì»¤ìŠ¤í…€ limit               â”‚
â”‚   C org        â”‚   72    â”‚    10     â”‚   10   â”‚  ê¸°ë³¸ limit                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   í•©ê³„ (ì œí•œå‰)â”‚  157    â”‚     -     â”‚   85   â”‚                             â”‚
â”‚                                                                              â”‚
â”‚   BUT! ì „ì²´ max_total = 100                                                  â”‚
â”‚   ì‹¤ì œ í• ë‹¹: A(25) + B(50) + C(10) = 85ê°œ (ë˜ëŠ” ì „ì²´ 100ê°œê¹Œì§€)              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì‹œê°„ì— ë”°ë¥¸ í• ë‹¹ ë³€í™”

```
ì‹œê°„   ì´ë²¤íŠ¸              Org   ìƒíƒœ                              ê²°ê³¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1    A-job-1 queued      A     A: 0/10, Total: 0/100            âœ… Runner ìƒì„±
T2    C-job-1 queued      C     C: 0/10, Total: 1/100            âœ… Runner ìƒì„±
T3    B-job-1 queued      B     B: 0/10, Total: 2/100            âœ… Runner ìƒì„±
...
T30   C-job-10 queued     C     C: 9/10, Total: 29/100           âœ… Runner ìƒì„±
T31   A-job-11 queued     A     A: 10/10 âŒ Org limit ë„ë‹¬        ğŸ“¥ Redis ëŒ€ê¸°ì—´
T32   B-job-11 queued     B     B: 10/10 âŒ Org limit ë„ë‹¬        ğŸ“¥ Redis ëŒ€ê¸°ì—´
...
T100  A-job-1 completed   A     A: 10â†’9, Total: 30â†’29            ğŸ”„ Pod ì‚­ì œ
                                Redis ëŒ€ê¸°ì—´ í™•ì¸ â†’ A-job-11 ë°œê²¬
T101  (ë‚´ë¶€) A-job-11     A     A: 9/10, Total: 29/100           âœ… Runner ìƒì„±
      íƒœìŠ¤í¬ í˜¸ì¶œë¨
```

---

## FIFO ìˆœì„œ ë³´ì¥

### ì „ì—­ FIFO (timestamp ê¸°ë°˜)

**ëª¨ë“  pending jobì— timestampê°€ í¬í•¨ë˜ì–´ ì „ì—­ FIFOë¥¼ ë³´ì¥í•©ë‹ˆë‹¤:**

```python
# ëŒ€ê¸°ì—´ì— ì¶”ê°€ ì‹œ timestamp í¬í•¨
job_data = {
    "job_id": job_id,
    "org_name": org_name,
    "timestamp": time.time(),  # ì „ì—­ FIFOë¥¼ ìœ„í•œ timestamp
    ...
}
redis.rpush(f"org:{org_name}:pending", json.dumps(job_data))

# ë°°ì¹˜ ì²˜ë¦¬ ì‹œ ëª¨ë“  Orgì˜ jobì„ timestamp ìˆœìœ¼ë¡œ ì •ë ¬
all_jobs = redis_client.peek_all_pending_jobs_sync()
# â†’ [(org_name, index, job_data), ...] sorted by timestamp
```

```
ì „ì—­ ëŒ€ê¸°ì—´ (timestamp ìˆœ ì •ë ¬):

ì‹œê°„ìˆœ    Org      Job ID     timestamp
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1      A org    A-job-11   1701590400.1  â† ê°€ì¥ ë¨¼ì € ì²˜ë¦¬
  2      B org    B-job-21   1701590400.5
  3      A org    A-job-12   1701590401.2
  4      C org    C-job-31   1701590401.5
  5      B org    B-job-22   1701590402.0
  ...
```

### Organization ë‚´ ìˆœì„œ

**Redis Listë¥¼ ì‚¬ìš©í•˜ì—¬ Org ë‚´ FIFOë„ ë³´ì¥ë©ë‹ˆë‹¤:**

```python
# ëŒ€ê¸°ì—´ì— ì¶”ê°€ (ì˜¤ë¥¸ìª½ ëì— ì¶”ê°€)
redis.rpush(f"org:{org_name}:pending", job_data)

# Org ë‚´ì—ì„œëŠ” List ìˆœì„œë¡œ FIFO ë³´ì¥
```

```
A org ëŒ€ê¸°ì—´ (FIFO):
  [A-job-11] â†’ [A-job-12] â†’ [A-job-13] â†’ ...
       â†‘                                    â†‘
      ë¨¼ì € ì¶”ê°€ë¨                        ë‚˜ì¤‘ì— ì¶”ê°€ë¨
```

### ë°°ì¹˜ ì²˜ë¦¬ì—ì„œì˜ ìˆœì„œ ë³´ì¥

`process_pending_queues` íƒœìŠ¤í¬ê°€ ëª¨ë“  Orgì˜ pending jobì„ ìˆ˜ì§‘í•˜ê³  timestamp ìˆœìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤:

```
process_pending_queues ì‹¤í–‰ ì‹œ (ë°°ì¹˜ ì²˜ë¦¬):
  1. ëª¨ë“  Orgì˜ pending job ìˆ˜ì§‘
  2. timestamp ìˆœìœ¼ë¡œ ì •ë ¬ (ì „ì—­ FIFO)
  3. ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•˜ë˜ Orgë³„ ì œí•œ í™•ì¸:
     â†’ A-job-11 (t=0.1): A org ì—¬ìœ  ìˆìŒ â†’ ì„ íƒ âœ“
     â†’ B-job-21 (t=0.5): B org ì—¬ìœ  ìˆìŒ â†’ ì„ íƒ âœ“
     â†’ A-job-12 (t=1.2): A org ì—¬ìœ  ìˆìŒ â†’ ì„ íƒ âœ“
     â†’ C-job-31 (t=1.5): C org limit ë„ë‹¬ â†’ ê±´ë„ˆëœ€
     â†’ ... (ìµœëŒ€ MAX_BATCH_SIZEê¹Œì§€)
  4. ì„ íƒëœ Jobë“¤ ì¼ê´„ ì²˜ë¦¬
```

**ê²°ê³¼:** ë¨¼ì € ìš”ì²­ëœ Jobì´ ë¨¼ì € ì²˜ë¦¬ë˜ë©°, Org ê°„ ê³µì •ì„±ë„ ë³´ì¥ë©ë‹ˆë‹¤.

---

## FAQ

### Q1: completed ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ì¹´ìš´í„°ê°€ ê°ì†Œí•˜ë‚˜ìš”?

**A:** `process_pending_queues` íƒœìŠ¤í¬ê°€ 5ì´ˆë§ˆë‹¤ K8s Pod ìƒíƒœë¥¼ ì¡°íšŒí•˜ì—¬ ì¹´ìš´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.

```python
# process_pending_queues ì‹¤í–‰ ì‹œ
def _sync_running_state(redis_client, k8s_client):
    # K8sì—ì„œ Running/Pending Podë§Œ ì¡°íšŒ
    running_pods = k8s_client.list_runner_pods()
    
    # ì‹¤ì œ Running Pod ìˆ˜ë¡œ Redis ì¹´ìš´í„° ê°±ì‹ 
    # â†’ ì¢…ë£Œëœ PodëŠ” ìë™ìœ¼ë¡œ ì¹´ìš´íŠ¸ì—ì„œ ì œì™¸
    redis_client.set_total_running_sync(actual_count)
```

Ephemeral RunnerëŠ” Job ì™„ë£Œ í›„ ìë™ ì¢…ë£Œë˜ë¯€ë¡œ, ë‹¤ìŒ ì¡°íšŒ ì‹œ ì¹´ìš´í„°ê°€ ìë™ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.

### Q2: Redis ëŒ€ê¸°ì—´ì— ì–´ë–¤ ì •ë³´ê°€ ì €ì¥ë˜ë‚˜ìš”?

**A:** Runner ìƒì„±ì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ê°€ JSON í˜•íƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤.

```json
{
    "job_id": 12345,
    "run_id": 67890,
    "job_name": "build",
    "repo_full_name": "org-A/my-repo",
    "labels": ["code-linux"],
    "org_name": "org-A"
}
```

### Q3: ì „ì²´ limitë³´ë‹¤ Org limit í•©ê³„ê°€ ì‘ìœ¼ë©´?

**A:** Orgë³„ limitì— ì˜í•´ ì „ì²´ limitì„ ë‹¤ ì‚¬ìš©í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
ì˜ˆì‹œ:
  - max_total: 100
  - 10ê°œ Org Ã— 10 limit = ìµœëŒ€ 100ê°œ ê°€ëŠ¥
  - 3ê°œ Org Ã— 10 limit = ìµœëŒ€ 30ê°œë§Œ ì‚¬ìš© (70ê°œ ìœ íœ´)
```

í•´ê²°ì±…: í™œì„± Orgê°€ ë§ìœ¼ë©´ Org limitì„ ë†’ì´ê±°ë‚˜, max_totalì„ ë‚®ì¶¥ë‹ˆë‹¤.

### Q4: Runner ìƒì„±ì— ì‹¤íŒ¨í•˜ë©´?

**A:** Celeryê°€ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤.

```python
@celery_app.task(bind=True, max_retries=3, default_retry_delay=30)
def create_runner_for_job(self, ...):
    try:
        # JIT Token ë°œê¸‰
        jit_config = github_client.create_jit_runner_config(...)
    except Exception as e:
        raise self.retry(exc=e)  # 30ì´ˆ í›„ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
```

### Q5: Redisì™€ ì‹¤ì œ Pod ìˆ˜ê°€ ë¶ˆì¼ì¹˜í•˜ë©´?

**A:** `process_pending_queues`ê°€ 5ì´ˆë§ˆë‹¤ ìƒíƒœë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.

```python
# process_pending_queues íƒœìŠ¤í¬ (5ì´ˆë§ˆë‹¤ ì‹¤í–‰)
# ëŒ€ê¸°ì—´ ì²˜ë¦¬ ì „ì— í•­ìƒ K8s ìƒíƒœ ë™ê¸°í™” ìˆ˜í–‰
def _sync_running_state(redis_client, k8s_client):
    running_pods = k8s_client.list_runner_pods()
    # Running/Pending Podë§Œ ì¹´ìš´íŠ¸í•˜ì—¬ Redis ê°±ì‹ 
```

ì¶”ê°€ë¡œ `sync_redis_state` íƒœìŠ¤í¬ê°€ 5ë¶„ë§ˆë‹¤ ì „ì²´ ë™ê¸°í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### Q6: Redis ì¥ì•  ì‹œ ëŒ€ê¸°ì—´ì´ ì†ì‹¤ë˜ë©´?

**A:** Redis persistence ì„¤ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

```yaml
# values.yaml
redis:
  master:
    persistence:
      enabled: true
      size: 1Gi
```

ë˜í•œ, GitHubì˜ Job íƒ€ì„ì•„ì›ƒ(ê¸°ë³¸ 6ì‹œê°„) ë‚´ì— Redisê°€ ë³µêµ¬ë˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Q7: ëŒ€ê¸° ì¤‘ì¸ Jobì´ GitHubì—ì„œ ì·¨ì†Œë˜ë©´?

**A:** í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” Redis ëŒ€ê¸°ì—´ì— ë‚¨ì•„ìˆê²Œ ë©ë‹ˆë‹¤. ì£¼ê¸°ì ì¸ ì •ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.

í–¥í›„ ê°œì„  ë°©ì•ˆ:
- `workflow_job.completed` (conclusion: cancelled) ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ëŒ€ê¸°ì—´ì—ì„œë„ ì œê±°
- ì£¼ê¸°ì ìœ¼ë¡œ GitHub APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì·¨ì†Œëœ Job ì •ë¦¬

### Q8: ë°°ì¹˜ ì²˜ë¦¬ë€ ë¬´ì—‡ì¸ê°€ìš”?

**A:** 5ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” `process_pending_queues`ê°€ í•œ ë²ˆì— ìµœëŒ€ 10ê°œ(MAX_BATCH_SIZE)ì˜ Jobì„ ë™ì‹œì— ì²˜ë¦¬í•©ë‹ˆë‹¤.

```python
# ê¸°ì¡´ ë°©ì‹: Orgë‹¹ 1ê°œì”© ì²˜ë¦¬
for org in pending_orgs:
    job = pop_pending_job(org)  # 1ê°œë§Œ
    create_runner(job)

# ë°°ì¹˜ ì²˜ë¦¬ ë°©ì‹: ìµœëŒ€ 10ê°œ ë™ì‹œ ì²˜ë¦¬
all_jobs = peek_all_pending_jobs()  # ëª¨ë“  Orgì˜ job ìˆ˜ì§‘
all_jobs.sort(key=lambda x: x.timestamp)  # timestamp ìˆœ ì •ë ¬

for job in all_jobs[:MAX_BATCH_SIZE]:
    if org_has_capacity(job.org):
        create_runner(job)  # ìµœëŒ€ 10ê°œ
```

**ì¥ì :**
- ëŒ€ê¸°ì—´ ì†Œì§„ ì†ë„ í–¥ìƒ
- ì „ì—­ FIFO ìˆœì„œ ë³´ì¥ (ë¨¼ì € ìš”ì²­ëœ Job ë¨¼ì € ì²˜ë¦¬)

### Q9: MAX_BATCH_SIZEë¥¼ ì¡°ì •í•  ìˆ˜ ìˆë‚˜ìš”?

**A:** ë„¤, í™˜ê²½ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.

```bash
# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
MAX_BATCH_SIZE=20  # í•œ ë²ˆì— ìµœëŒ€ 20ê°œ ì²˜ë¦¬ (ê¸°ë³¸ê°’: 10)
```

ì£¼ì˜ì‚¬í•­:
- ë„ˆë¬´ í¬ê²Œ ì„¤ì •í•˜ë©´ GitHub API rate limitì— ë„ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- Celery Worker ìˆ˜ì™€ K8s í´ëŸ¬ìŠ¤í„° ìš©ëŸ‰ì„ ê³ ë ¤í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”

### Q10: timestampê°€ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„°ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ë‚˜ìš”?

**A:** í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ timestampê°€ ì—†ëŠ” Jobì€ `timestamp=0`ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

```python
# timestampê°€ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±
if "timestamp" not in job_data:
    job_data["timestamp"] = 0  # ê°€ì¥ ì˜¤ë˜ëœ ê²ƒìœ¼ë¡œ ì·¨ê¸‰
```

ì´ë ‡ê²Œ í•˜ë©´ ê¸°ì¡´ ëŒ€ê¸°ì—´ì˜ Jobì´ ìƒˆë¡œìš´ Jobë³´ë‹¤ ë¨¼ì € ì²˜ë¦¬ë©ë‹ˆë‹¤.

---

## ê´€ë ¨ ë¬¸ì„œ

- [README.md](../README.md) - ì „ì²´ ì‹œìŠ¤í…œ ê°œìš”
- [Enterprise Webhook ì„¤ì •](enterprise-webhook-setup.md) - Webhook êµ¬ì„± ê°€ì´ë“œ
- [GitHub Actions - Self-hosted runners](https://docs.github.com/en/actions/hosting-your-own-runners)
