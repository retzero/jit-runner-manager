# Runner ìƒì„± ë¡œì§ ìƒì„¸ ì„¤ëª…

JIT Runner Managerì˜ Runner ìƒì„± ë° ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë¡œì§ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì²˜ë¦¬ íë¦„](#ì²˜ë¦¬-íë¦„)
3. [ì œí•œ í™•ì¸ ë¡œì§](#ì œí•œ-í™•ì¸-ë¡œì§)
4. [ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë°©ì‹](#ëŒ€ê¸°ì—´-ì²˜ë¦¬-ë°©ì‹)
5. [ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ](#ì‹œë‚˜ë¦¬ì˜¤-ì˜ˆì‹œ)
6. [FIFO ìˆœì„œ ë³´ì¥](#fifo-ìˆœì„œ-ë³´ì¥)
7. [FAQ](#faq)

---

## ê°œìš”

JIT Runner ManagerëŠ” GitHub Enterprise Serverì—ì„œ workflowê°€ ì‹œì‘ë  ë•Œ ì‹¤ì‹œê°„ìœ¼ë¡œ Runnerë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### í•µì‹¬ ì›ì¹™

| ì—­í•  | ë‹´ë‹¹ |
|------|------|
| Runner ìƒì„± ê²°ì • | JIT Runner Manager |
| **ëŒ€ê¸°ì—´ ê´€ë¦¬** | **JIT Runner Manager (Redis)** |
| Webhook ë°œì†¡ | GitHub Enterprise Server (1íšŒë§Œ) |

### ì¤‘ìš”í•œ ì 

> âš ï¸ **GitHubì€ `workflow_job.queued` webhookì„ ì¬ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!**
>
> Webhookì€ Job ìƒíƒœê°€ ë³€ê²½ë  ë•Œ **1íšŒë§Œ** ë°œì†¡ë©ë‹ˆë‹¤.
> ë”°ë¼ì„œ JIT Runner Managerê°€ **ìì²´ ëŒ€ê¸°ì—´**ì„ Redisì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.

---

## ì²˜ë¦¬ íë¦„

### ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GitHub Enterprise Server                            â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         Workflow Jobs                                 â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚  â€¢ ìƒˆ workflow ì‹œì‘ â†’ queued ì´ë²¤íŠ¸ ë°œìƒ (1íšŒë§Œ!)                     â”‚  â”‚
â”‚   â”‚  â€¢ Runner ì—†ìœ¼ë©´ â†’ GitHub UIì—ì„œ "Waiting for runner" í‘œì‹œ           â”‚  â”‚
â”‚   â”‚  â€¢ íƒ€ì„ì•„ì›ƒ (ê¸°ë³¸ 6ì‹œê°„) í›„ ì‹¤íŒ¨ ì²˜ë¦¬                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                               â”‚
â”‚                    workflow_job webhook (1íšŒ ë°œì†¡)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         JIT Runner Manager                                    â”‚
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ FastAPI Webhook â”‚â”€â”€â”€â”€â–¶â”‚  Celery Worker  â”‚â”€â”€â”€â”€â–¶â”‚  Kubernetes     â”‚       â”‚
â”‚   â”‚   Receiver      â”‚     â”‚                 â”‚     â”‚  (Pod ìƒì„±)     â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                           â”‚     Redis       â”‚                                â”‚
â”‚                           â”‚  (ìƒíƒœ + ëŒ€ê¸°ì—´) â”‚  â—€â”€â”€ ìì²´ ëŒ€ê¸°ì—´ ê´€ë¦¬!        â”‚
â”‚                           â”‚  â€¢ org:X:runningâ”‚                                â”‚
â”‚                           â”‚  â€¢ org:X:pendingâ”‚  â—€â”€â”€ ëŒ€ê¸° ì¤‘ì¸ Job ëª©ë¡       â”‚
â”‚                           â”‚  â€¢ global:total â”‚                                â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì´ë²¤íŠ¸ë³„ ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        workflow_job.queued ì´ë²¤íŠ¸                            â”‚
â”‚                                                                              â”‚
â”‚  1. Webhook ìˆ˜ì‹  â†’ ë¼ë²¨ í™•ì¸ (code-linux)                                    â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  2. Celery Taskë¡œ ë¹„ë™ê¸° ì²˜ë¦¬                                                â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  3. ì œí•œ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â”‚                                                          â”‚            â”‚
â”‚     â”œâ”€ org_running >= org_limit? â”€â”€â”€Yesâ”€â”€â”€â–¶ Redis ëŒ€ê¸°ì—´ ì €ì¥  â”‚            â”‚
â”‚     â”‚         â”‚                            (ì „ì²´ Job ì •ë³´)     â”‚            â”‚
â”‚     â”‚        No                                                â”‚            â”‚
â”‚     â”‚         â”‚                                                â”‚            â”‚
â”‚     â”œâ”€ total_running >= max_total? â”€Yesâ”€â”€â”€â–¶ Redis ëŒ€ê¸°ì—´ ì €ì¥  â”‚            â”‚
â”‚     â”‚         â”‚                                                â”‚            â”‚
â”‚     â”‚        No                                                â”‚            â”‚
â”‚     â”‚         â–¼                                                â”‚            â”‚
â”‚  4. JIT Token ë°œê¸‰ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  5. K8s Pod ìƒì„±                                                             â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  6. Redis ì¹´ìš´í„° ì¦ê°€ (org_running++, total_running++)                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       workflow_job.completed ì´ë²¤íŠ¸                          â”‚
â”‚                                                                              â”‚
â”‚  1. Redis ì¹´ìš´í„° ê°ì†Œ (org_running--, total_running--)                       â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  2. K8s Pod ì‚­ì œ                                                             â”‚
â”‚                         â”‚                                                    â”‚
â”‚                         â–¼                                                    â”‚
â”‚  3. Redis ëŒ€ê¸°ì—´ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚     â”‚                                                                       â”‚â”‚
â”‚     â””â”€ ëŒ€ê¸° ì¤‘ì¸ Job ìˆìŒ? â”€â”€â”€Yesâ”€â”€â”€â–¶ Runner ìƒì„± íƒœìŠ¤í¬ í˜¸ì¶œ!              â”‚â”‚
â”‚                                       (process_workflow_job_queued.delay)   â”‚â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì œí•œ í™•ì¸ ë¡œì§

### 2ë‹¨ê³„ ì œí•œ í™•ì¸

Runner ìƒì„± ì „ì— ë‘ ê°€ì§€ ì œí•œì„ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤:

```python
# 1. Organization ì œí•œ í™•ì¸
org_running = redis_client.get_org_running_count_sync(org_name)
org_limit = redis_client.get_effective_org_limit_sync(org_name)  # ì»¤ìŠ¤í…€ ë˜ëŠ” ê¸°ë³¸ê°’

if org_running >= org_limit:
    # Redis ëŒ€ê¸°ì—´ì— Job ì •ë³´ ì €ì¥
    redis_client.add_pending_job_sync(
        org_name=org_name,
        job_id=job_id,
        run_id=run_id,
        job_name=job_name,
        repo_full_name=repo_full_name,
        labels=labels
    )
    return {"status": "pending", "reason": "org_limit_reached"}

# 2. ì „ì²´ ì œí•œ í™•ì¸
total_running = redis_client.get_total_running_sync()

if total_running >= config.runner.max_total:
    # Redis ëŒ€ê¸°ì—´ì— Job ì •ë³´ ì €ì¥
    redis_client.add_pending_job_sync(...)
    return {"status": "pending", "reason": "total_limit_reached"}

# ë‘ ì¡°ê±´ ëª¨ë‘ í†µê³¼ â†’ Runner ìƒì„±
```

### ì œí•œ ìš°ì„ ìˆœìœ„

```
                    ìš”ì²­ ë„ì°©
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Org ì œí•œ (org_limit)   â”‚  â† ë¨¼ì € í™•ì¸
            â”‚ ì˜ˆ: A org = 10ê°œ      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              org_running < org_limit?
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             Yes                  No
              â”‚                    â”‚
              â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì „ì²´ ì œí•œ í™•ì¸   â”‚    â”‚ Redis ëŒ€ê¸°ì—´    â”‚
    â”‚ max_total=100   â”‚    â”‚ ì €ì¥ (FIFO)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    total_running < max_total?
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
   Yes               No
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Runner  â”‚   â”‚ Redis ëŒ€ê¸°ì—´    â”‚
â”‚  ìƒì„±   â”‚   â”‚ ì €ì¥ (FIFO)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì»¤ìŠ¤í…€ Org ì œí•œ

Organizationë³„ë¡œ ë‹¤ë¥¸ ì œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

| Organization | ì»¤ìŠ¤í…€ ì œí•œ | ì ìš© ì œí•œ |
|--------------|------------|----------|
| platform-team | 25 | 25 |
| small-project | 5 | 5 |
| regular-org | (ì—†ìŒ) | 10 (ê¸°ë³¸ê°’) |

```python
def get_effective_org_limit_sync(self, org_name: str) -> int:
    """Organizationì˜ ìœ íš¨ ì œí•œ ì¡°íšŒ (ì»¤ìŠ¤í…€ ë˜ëŠ” ê¸°ë³¸ê°’)"""
    custom_limit = self.get_org_max_limit_sync(org_name)
    if custom_limit is not None:
        return custom_limit
    return self.config.runner.max_per_org  # ê¸°ë³¸ê°’ (ì˜ˆ: 10)
```

---

## ëŒ€ê¸°ì—´ ì²˜ë¦¬ ë°©ì‹

### í•µì‹¬: JIT Runner Managerê°€ Redisì—ì„œ ëŒ€ê¸°ì—´ ê´€ë¦¬

**GitHubì€ Webhookì„ ì¬ì „ì†¡í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ**, JIT Runner Managerê°€ ìì²´ ëŒ€ê¸°ì—´ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Redis                                            â”‚
â”‚                                                                               â”‚
â”‚   ëŒ€ê¸°ì—´ (org:{name}:pending):                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â”‚  org:A:pending = [                                                   â”‚    â”‚
â”‚   â”‚    {"job_id": 11, "run_id": 101, "repo": "org-A/repo1", ...},       â”‚    â”‚
â”‚   â”‚    {"job_id": 12, "run_id": 102, "repo": "org-A/repo2", ...},       â”‚    â”‚
â”‚   â”‚    ...                                                               â”‚    â”‚
â”‚   â”‚  ]                                                                   â”‚    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â”‚  org:B:pending = [                                                   â”‚    â”‚
â”‚   â”‚    {"job_id": 21, "run_id": 201, "repo": "org-B/repo1", ...},       â”‚    â”‚
â”‚   â”‚    ...                                                               â”‚    â”‚
â”‚   â”‚  ]                                                                   â”‚    â”‚
â”‚   â”‚                                                                      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                               â”‚
â”‚   Runner ì™„ë£Œ ì‹œ â†’ í•´ë‹¹ Org ëŒ€ê¸°ì—´ì—ì„œ Job êº¼ë‚´ì„œ Runner ìƒì„±                 â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ëŒ€ê¸°ì—´ ì €ì¥ ì •ë³´

ì œí•œì— ë„ë‹¬í•˜ë©´ ì „ì²´ Job ì •ë³´ë¥¼ Redisì— ì €ì¥í•©ë‹ˆë‹¤:

```python
# Redis ëŒ€ê¸°ì—´ì— ì €ì¥ë˜ëŠ” ì •ë³´ (JSON)
{
    "job_id": 12345,
    "run_id": 67890,
    "job_name": "build",
    "repo_full_name": "org-A/my-repo",
    "labels": ["code-linux"],
    "org_name": "org-A"
}
```

### ì²˜ë¦¬ ìˆœì„œ

```
1. A-job-11 queued ì´ë²¤íŠ¸ ë„ì°©
   â””â”€â”€ JIT Runner Manager: "A org ì´ë¯¸ 10ê°œ ì‹¤í–‰ ì¤‘"
   â””â”€â”€ Redis ëŒ€ê¸°ì—´ì— ì €ì¥: org:A:pending.push(job-11 ì •ë³´)

2. A-job-1 completed ì´ë²¤íŠ¸ ë„ì°©
   â””â”€â”€ JIT Runner Manager: Redis ì¹´ìš´í„° ê°ì†Œ (A: 10â†’9)
   â””â”€â”€ JIT Runner Manager: K8s Pod ì‚­ì œ
   â””â”€â”€ JIT Runner Manager: Redis ëŒ€ê¸°ì—´ í™•ì¸
   â””â”€â”€ ëŒ€ê¸° Job ë°œê²¬! â†’ process_workflow_job_queued.delay(job-11 ì •ë³´)

3. Celery Workerê°€ job-11 ì²˜ë¦¬
   â””â”€â”€ A org: 9/10 (ì—¬ìœ  ìˆìŒ) â†’ Runner ìƒì„±!
```

### êµ¬ì„±ìš”ì†Œë³„ ì—­í• 

| êµ¬ì„±ìš”ì†Œ | ì—­í•  | ëŒ€ê¸°ì—´ ê´€ë¦¬ |
|---------|------|------------|
| FastAPI Webhook | ì´ë²¤íŠ¸ ìˆ˜ì‹  | âŒ |
| Celery Worker | Runner ìƒì„±/ì‚­ì œ, **ëŒ€ê¸°ì—´ ì²˜ë¦¬** | âœ… |
| **Redis** | ìƒíƒœ ì €ì¥, **ëŒ€ê¸°ì—´ ì €ì¥** | âœ… |
| GitHub | Workflow ì‹¤í–‰ | âŒ (Webhook ì¬ì „ì†¡ ì•ˆí•¨) |

---

## ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤: ëŒ€ê·œëª¨ ë™ì‹œ ìš”ì²­

**ì¡°ê±´:**
- A org: 35ê°œ ìš”ì²­, limit: 10
- B org: 50ê°œ ìš”ì²­, limit: 10
- C org: 72ê°œ ìš”ì²­, limit: 10
- ì „ì²´ max_total: 100

**ê²°ê³¼ ë¶„ì„:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ìš”ì²­ í˜„í™©                                       â”‚
â”‚                                                                              â”‚
â”‚   Organization â”‚ ìš”ì²­ ìˆ˜ â”‚ Org Limit â”‚ í• ë‹¹ë¨ â”‚ Redis ëŒ€ê¸°ì—´                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   A org        â”‚   35    â”‚    10     â”‚   10   â”‚  25ê°œ ëŒ€ê¸°                  â”‚
â”‚   B org        â”‚   50    â”‚    10     â”‚   10   â”‚  40ê°œ ëŒ€ê¸°                  â”‚
â”‚   C org        â”‚   72    â”‚    10     â”‚   10   â”‚  62ê°œ ëŒ€ê¸°                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   í•©ê³„         â”‚  157    â”‚     -     â”‚   30   â”‚ 127ê°œ ëŒ€ê¸°                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ í¬ì¸íŠ¸:**
- ì „ì²´ max_totalì´ 100ì´ì§€ë§Œ, **Orgë³„ limit(10)ìœ¼ë¡œ ì¸í•´ 30ê°œë§Œ ì‚¬ìš©**
- 127ê°œ ìš”ì²­ì€ **Redis ëŒ€ê¸°ì—´**ì—ì„œ ìˆœì„œ ëŒ€ê¸°
- Runner ì™„ë£Œ ì‹œ í•´ë‹¹ Orgì˜ ëŒ€ê¸°ì—´ì—ì„œ ë‹¤ìŒ Job ì²˜ë¦¬

### ì‹œë‚˜ë¦¬ì˜¤: ì»¤ìŠ¤í…€ ì œí•œ ì ìš©

**ì¡°ê±´:**
- A org: 35ê°œ ìš”ì²­, **custom limit: 25**
- B org: 50ê°œ ìš”ì²­, **custom limit: 50**
- C org: 72ê°œ ìš”ì²­, limit: 10 (ê¸°ë³¸ê°’)
- ì „ì²´ max_total: 100

**ê²°ê³¼:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Organization â”‚ ìš”ì²­ ìˆ˜ â”‚ Org Limit â”‚ í• ë‹¹ë¨ â”‚ ë¹„ê³                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   A org        â”‚   35    â”‚    25     â”‚   25   â”‚  ì»¤ìŠ¤í…€ limit               â”‚
â”‚   B org        â”‚   50    â”‚    50     â”‚   50   â”‚  ì»¤ìŠ¤í…€ limit               â”‚
â”‚   C org        â”‚   72    â”‚    10     â”‚   10   â”‚  ê¸°ë³¸ limit                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚   í•©ê³„ (ì œí•œå‰)â”‚  157    â”‚     -     â”‚   85   â”‚                             â”‚
â”‚                                                                              â”‚
â”‚   BUT! ì „ì²´ max_total = 100                                                  â”‚
â”‚   ì‹¤ì œ í• ë‹¹: A(25) + B(50) + C(10) = 85ê°œ (ë˜ëŠ” ì „ì²´ 100ê°œê¹Œì§€)              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì‹œê°„ì— ë”°ë¥¸ í• ë‹¹ ë³€í™”

```
ì‹œê°„   ì´ë²¤íŠ¸              Org   ìƒíƒœ                              ê²°ê³¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1    A-job-1 queued      A     A: 0/10, Total: 0/100            âœ… Runner ìƒì„±
T2    C-job-1 queued      C     C: 0/10, Total: 1/100            âœ… Runner ìƒì„±
T3    B-job-1 queued      B     B: 0/10, Total: 2/100            âœ… Runner ìƒì„±
...
T30   C-job-10 queued     C     C: 9/10, Total: 29/100           âœ… Runner ìƒì„±
T31   A-job-11 queued     A     A: 10/10 âŒ Org limit ë„ë‹¬        ğŸ“¥ Redis ëŒ€ê¸°ì—´
T32   B-job-11 queued     B     B: 10/10 âŒ Org limit ë„ë‹¬        ğŸ“¥ Redis ëŒ€ê¸°ì—´
...
T100  A-job-1 completed   A     A: 10â†’9, Total: 30â†’29            ğŸ”„ Pod ì‚­ì œ
                                Redis ëŒ€ê¸°ì—´ í™•ì¸ â†’ A-job-11 ë°œê²¬
T101  (ë‚´ë¶€) A-job-11     A     A: 9/10, Total: 29/100           âœ… Runner ìƒì„±
      íƒœìŠ¤í¬ í˜¸ì¶œë¨
```

---

## FIFO ìˆœì„œ ë³´ì¥

### Organization ë‚´ ìˆœì„œ

**Redis Listë¥¼ ì‚¬ìš©í•˜ì—¬ FIFOë¥¼ ë³´ì¥í•©ë‹ˆë‹¤:**

```python
# ëŒ€ê¸°ì—´ì— ì¶”ê°€ (ì˜¤ë¥¸ìª½ ëì— ì¶”ê°€)
redis.rpush(f"org:{org_name}:pending", job_data)

# ëŒ€ê¸°ì—´ì—ì„œ êº¼ë‚´ê¸° (ì™¼ìª½ ëì—ì„œ êº¼ëƒ„ = FIFO)
job_data = redis.lpop(f"org:{org_name}:pending")
```

```
A org ëŒ€ê¸°ì—´ (FIFO):
  [A-job-11] â†’ [A-job-12] â†’ [A-job-13] â†’ ...
       â†‘                                    â†‘
      ë¨¼ì € êº¼ëƒ„                          ë‚˜ì¤‘ì— ì¶”ê°€ë¨
```

### Organization ê°„ ìˆœì„œ

Runner ì™„ë£Œ ì‹œ **í•´ë‹¹ Organizationì˜ ëŒ€ê¸°ì—´**ì—ì„œë§Œ ë‹¤ìŒ Jobì„ ì²˜ë¦¬í•©ë‹ˆë‹¤:

```
A-job-1 ì™„ë£Œ â†’ A org ëŒ€ê¸°ì—´ì—ì„œ A-job-11 êº¼ëƒ„
B-job-1 ì™„ë£Œ â†’ B org ëŒ€ê¸°ì—´ì—ì„œ B-job-11 êº¼ëƒ„
C-job-1 ì™„ë£Œ â†’ C org ëŒ€ê¸°ì—´ì—ì„œ C-job-11 êº¼ëƒ„
```

ê° OrgëŠ” ë…ë¦½ì ìœ¼ë¡œ ëŒ€ê¸°ì—´ì´ ê´€ë¦¬ë˜ë¯€ë¡œ, Org ê°„ ê³µì •ì„±ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë³´ì¥ë©ë‹ˆë‹¤.

---

## FAQ

### Q1: GitHubì´ Webhookì„ ì¬ì „ì†¡í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ëŒ€ê¸° Jobì„ ì²˜ë¦¬í•˜ë‚˜ìš”?

**A:** JIT Runner Managerê°€ ìì²´ ëŒ€ê¸°ì—´ì„ Redisì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.

```python
# workflow_job.completed ì²˜ë¦¬ ì‹œ
pending_job = redis_client.pop_pending_job_sync(org_name)
if pending_job:
    # ëŒ€ê¸° ì¤‘ì¸ Jobì— ëŒ€í•´ Runner ìƒì„± íƒœìŠ¤í¬ í˜¸ì¶œ
    process_workflow_job_queued.delay(
        org_name=pending_job.get("org_name"),
        job_id=pending_job.get("job_id"),
        run_id=pending_job.get("run_id"),
        job_name=pending_job.get("job_name"),
        repo_full_name=pending_job.get("repo_full_name"),
        labels=pending_job.get("labels", [])
    )
```

### Q2: Redis ëŒ€ê¸°ì—´ì— ì–´ë–¤ ì •ë³´ê°€ ì €ì¥ë˜ë‚˜ìš”?

**A:** Runner ìƒì„±ì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ê°€ JSON í˜•íƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤.

```json
{
    "job_id": 12345,
    "run_id": 67890,
    "job_name": "build",
    "repo_full_name": "org-A/my-repo",
    "labels": ["code-linux"],
    "org_name": "org-A"
}
```

### Q3: ì „ì²´ limitë³´ë‹¤ Org limit í•©ê³„ê°€ ì‘ìœ¼ë©´?

**A:** Orgë³„ limitì— ì˜í•´ ì „ì²´ limitì„ ë‹¤ ì‚¬ìš©í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
ì˜ˆì‹œ:
  - max_total: 100
  - 10ê°œ Org Ã— 10 limit = ìµœëŒ€ 100ê°œ ê°€ëŠ¥
  - 3ê°œ Org Ã— 10 limit = ìµœëŒ€ 30ê°œë§Œ ì‚¬ìš© (70ê°œ ìœ íœ´)
```

í•´ê²°ì±…: í™œì„± Orgê°€ ë§ìœ¼ë©´ Org limitì„ ë†’ì´ê±°ë‚˜, max_totalì„ ë‚®ì¶¥ë‹ˆë‹¤.

### Q4: Runner ìƒì„±ì— ì‹¤íŒ¨í•˜ë©´?

**A:** Celeryê°€ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤.

```python
@celery_app.task(bind=True, max_retries=3, default_retry_delay=30)
def process_workflow_job_queued(self, ...):
    try:
        # JIT Token ë°œê¸‰
        jit_config = github_client.create_jit_runner_config(...)
    except Exception as e:
        raise self.retry(exc=e)  # 30ì´ˆ í›„ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
```

### Q5: Redisì™€ ì‹¤ì œ Pod ìˆ˜ê°€ ë¶ˆì¼ì¹˜í•˜ë©´?

**A:** ì£¼ê¸°ì  ë™ê¸°í™” íƒœìŠ¤í¬ê°€ ìˆ˜ì •í•©ë‹ˆë‹¤.

```python
# 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
@celery_app.task
def sync_redis_state():
    # K8sì—ì„œ ì‹¤ì œ Running Pod ì¡°íšŒ
    running_pods = k8s_client.list_runner_pods()
    
    # Redis ì¹´ìš´í„°ì™€ ë¹„êµí•˜ì—¬ ë¶ˆì¼ì¹˜ ìˆ˜ì •
    if redis_count != k8s_count:
        redis_client.set_total_running_sync(k8s_count)
```

### Q6: Redis ì¥ì•  ì‹œ ëŒ€ê¸°ì—´ì´ ì†ì‹¤ë˜ë©´?

**A:** Redis persistence ì„¤ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

```yaml
# values.yaml
redis:
  master:
    persistence:
      enabled: true
      size: 1Gi
```

ë˜í•œ, GitHubì˜ Job íƒ€ì„ì•„ì›ƒ(ê¸°ë³¸ 6ì‹œê°„) ë‚´ì— Redisê°€ ë³µêµ¬ë˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Q7: ëŒ€ê¸° ì¤‘ì¸ Jobì´ GitHubì—ì„œ ì·¨ì†Œë˜ë©´?

**A:** í˜„ì¬ êµ¬í˜„ì—ì„œëŠ” Redis ëŒ€ê¸°ì—´ì— ë‚¨ì•„ìˆê²Œ ë©ë‹ˆë‹¤. ì£¼ê¸°ì ì¸ ì •ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.

í–¥í›„ ê°œì„  ë°©ì•ˆ:
- `workflow_job.completed` (conclusion: cancelled) ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ëŒ€ê¸°ì—´ì—ì„œë„ ì œê±°
- ì£¼ê¸°ì ìœ¼ë¡œ GitHub APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì·¨ì†Œëœ Job ì •ë¦¬

---

## ê´€ë ¨ ë¬¸ì„œ

- [README.md](../README.md) - ì „ì²´ ì‹œìŠ¤í…œ ê°œìš”
- [Enterprise Webhook ì„¤ì •](enterprise-webhook-setup.md) - Webhook êµ¬ì„± ê°€ì´ë“œ
- [GitHub Actions - Self-hosted runners](https://docs.github.com/en/actions/hosting-your-own-runners)
