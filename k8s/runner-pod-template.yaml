# JIT Runner Pod 템플릿
# 이 파일은 참고용이며, 실제 Pod는 k8s_client.py에서 동적으로 생성됩니다.
---
apiVersion: v1
kind: Pod
metadata:
  name: jit-runner-{job_id}
  namespace: jit-runners
  labels:
    app: jit-runner
    org: "{org_name}"
    job-id: "{job_id}"
    runner-name: "jit-runner-{job_id}"
  annotations:
    jit-runner-manager/created-by: jit-runner-manager
    jit-runner-manager/org: "{org_name}"
    jit-runner-manager/job-id: "{job_id}"
spec:
  restartPolicy: Never
  
  containers:
    # GitHub Actions Runner 컨테이너
    - name: runner
      image: ghcr.io/actions/actions-runner:latest
      imagePullPolicy: IfNotPresent
      
      command: ["/bin/sh", "-c"]
      args:
        - |
          # JIT config를 사용하여 Runner 실행
          echo "{encoded_jit_config}" | base64 -d > /home/runner/.runner
          /home/runner/run.sh --jitconfig /home/runner/.runner
      
      env:
        # Docker Host 설정 (DinD 사이드카 연결)
        - name: DOCKER_HOST
          value: "unix:///var/run/docker.sock"
        # Root로 실행 허용 (필요시)
        - name: RUNNER_ALLOW_RUNASROOT
          value: "1"
      
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2"
          memory: "4Gi"
      
      volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: dind-sock
          mountPath: /var/run

    # Docker-in-Docker 사이드카 컨테이너
    - name: dind
      image: docker:dind
      imagePullPolicy: IfNotPresent
      
      args:
        - dockerd
        - --host=unix:///var/run/docker.sock
        - --host=tcp://0.0.0.0:2376
      
      securityContext:
        privileged: true
      
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2"
          memory: "4Gi"
      
      volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: dind-sock
          mountPath: /var/run
        - name: dind-storage
          mountPath: /var/lib/docker

  volumes:
    # Runner 작업 디렉토리 (공유)
    - name: work
      emptyDir: {}
    
    # Docker 소켓 공유
    - name: dind-sock
      emptyDir: {}
    
    # Docker 이미지/레이어 저장소
    - name: dind-storage
      emptyDir: {}

  # Node Selector (선택사항)
  # nodeSelector:
  #   kubernetes.io/os: linux
  #   node-role.kubernetes.io/runner: "true"
  
  # Tolerations (선택사항)
  # tolerations:
  #   - key: "dedicated"
  #     operator: "Equal"
  #     value: "runner"
  #     effect: "NoSchedule"
  
  # Affinity (선택사항)
  # affinity:
  #   podAntiAffinity:
  #     preferredDuringSchedulingIgnoredDuringExecution:
  #       - weight: 100
  #         podAffinityTerm:
  #           labelSelector:
  #             matchLabels:
  #               app: jit-runner
  #           topologyKey: kubernetes.io/hostname

